"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "sanitizeQueryValue", {
    enumerable: true,
    get: function() {
        return sanitizeQueryValue;
    }
});
const _mongoose = /*#__PURE__*/ _interop_require_default(require("mongoose"));
const _utilities = require("payload/utilities");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const sanitizeQueryValue = ({ field, hasCustomID, operator, path, val })=>{
    let formattedValue = val;
    // Disregard invalid _ids
    if (path === '_id' && typeof val === 'string' && val.split(',').length === 1) {
        if (!hasCustomID) {
            const isValid = _mongoose.default.Types.ObjectId.isValid(val);
            if (!isValid) {
                return undefined;
            }
        }
        if (field.type === 'number') {
            const parsedNumber = parseFloat(val);
            if (Number.isNaN(parsedNumber)) {
                return undefined;
            }
        }
    }
    // Cast incoming values as proper searchable types
    if (field.type === 'checkbox' && typeof val === 'string') {
        if (val.toLowerCase() === 'true') formattedValue = true;
        if (val.toLowerCase() === 'false') formattedValue = false;
    }
    if ([
        'all',
        'in',
        'not_in'
    ].includes(operator) && typeof formattedValue === 'string') {
        formattedValue = (0, _utilities.createArrayFromCommaDelineated)(formattedValue);
        if (field.type === 'number') {
            formattedValue = formattedValue.map((arrayVal)=>parseFloat(arrayVal));
        }
    }
    if (field.type === 'number' && typeof formattedValue === 'string') {
        formattedValue = Number(val);
    }
    if (field.type === 'date' && typeof val === 'string') {
        formattedValue = new Date(val);
        if (Number.isNaN(Date.parse(formattedValue))) {
            return undefined;
        }
    }
    if ([
        'relationship',
        'upload'
    ].includes(field.type)) {
        if (val === 'null') {
            formattedValue = null;
        }
        if (operator === 'in' && Array.isArray(formattedValue)) {
            formattedValue = formattedValue.reduce((formattedValues, inVal)=>{
                const newValues = [
                    inVal
                ];
                if (_mongoose.default.Types.ObjectId.isValid(inVal)) newValues.push(new _mongoose.default.Types.ObjectId(inVal));
                const parsedNumber = parseFloat(inVal);
                if (!Number.isNaN(parsedNumber)) newValues.push(parsedNumber);
                return [
                    ...formattedValues,
                    ...newValues
                ];
            }, []);
        }
    }
    // Set up specific formatting necessary by operators
    if (operator === 'near') {
        let lng;
        let lat;
        let maxDistance;
        let minDistance;
        if (Array.isArray(formattedValue)) {
            [lng, lat, maxDistance, minDistance] = formattedValue;
        }
        if (typeof formattedValue === 'string') {
            [lng, lat, maxDistance, minDistance] = (0, _utilities.createArrayFromCommaDelineated)(formattedValue);
        }
        if (lng == null || lat == null || maxDistance == null && minDistance == null) {
            formattedValue = undefined;
        } else {
            formattedValue = {
                $geometry: {
                    coordinates: [
                        parseFloat(lng),
                        parseFloat(lat)
                    ],
                    type: 'Point'
                }
            };
            if (maxDistance) formattedValue.$maxDistance = parseFloat(maxDistance);
            if (minDistance) formattedValue.$minDistance = parseFloat(minDistance);
        }
    }
    if (operator === 'within' || operator === 'intersects') {
        formattedValue = {
            $geometry: formattedValue
        };
    }
    if (path !== '_id' || path === '_id' && hasCustomID && field.type === 'text') {
        if (operator === 'contains') {
            formattedValue = {
                $options: 'i',
                $regex: formattedValue
            };
        }
    }
    if (operator === 'exists') {
        formattedValue = formattedValue === 'true' || formattedValue === true;
    }
    return formattedValue;
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyaWVzL3Nhbml0aXplUXVlcnlWYWx1ZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEZpZWxkLCBUYWJBc0ZpZWxkIH0gZnJvbSAncGF5bG9hZC90eXBlcydcblxuaW1wb3J0IG1vbmdvb3NlIGZyb20gJ21vbmdvb3NlJ1xuaW1wb3J0IHsgY3JlYXRlQXJyYXlGcm9tQ29tbWFEZWxpbmVhdGVkIH0gZnJvbSAncGF5bG9hZC91dGlsaXRpZXMnXG5cbnR5cGUgU2FuaXRpemVRdWVyeVZhbHVlQXJncyA9IHtcbiAgZmllbGQ6IEZpZWxkIHwgVGFiQXNGaWVsZFxuICBoYXNDdXN0b21JRDogYm9vbGVhblxuICBvcGVyYXRvcjogc3RyaW5nXG4gIHBhdGg6IHN0cmluZ1xuICB2YWw6IGFueVxufVxuXG5leHBvcnQgY29uc3Qgc2FuaXRpemVRdWVyeVZhbHVlID0gKHtcbiAgZmllbGQsXG4gIGhhc0N1c3RvbUlELFxuICBvcGVyYXRvcixcbiAgcGF0aCxcbiAgdmFsLFxufTogU2FuaXRpemVRdWVyeVZhbHVlQXJncyk6IHVua25vd24gPT4ge1xuICBsZXQgZm9ybWF0dGVkVmFsdWUgPSB2YWxcblxuICAvLyBEaXNyZWdhcmQgaW52YWxpZCBfaWRzXG4gIGlmIChwYXRoID09PSAnX2lkJyAmJiB0eXBlb2YgdmFsID09PSAnc3RyaW5nJyAmJiB2YWwuc3BsaXQoJywnKS5sZW5ndGggPT09IDEpIHtcbiAgICBpZiAoIWhhc0N1c3RvbUlEKSB7XG4gICAgICBjb25zdCBpc1ZhbGlkID0gbW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQuaXNWYWxpZCh2YWwpXG5cbiAgICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGZpZWxkLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICBjb25zdCBwYXJzZWROdW1iZXIgPSBwYXJzZUZsb2F0KHZhbClcblxuICAgICAgaWYgKE51bWJlci5pc05hTihwYXJzZWROdW1iZXIpKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBDYXN0IGluY29taW5nIHZhbHVlcyBhcyBwcm9wZXIgc2VhcmNoYWJsZSB0eXBlc1xuICBpZiAoZmllbGQudHlwZSA9PT0gJ2NoZWNrYm94JyAmJiB0eXBlb2YgdmFsID09PSAnc3RyaW5nJykge1xuICAgIGlmICh2YWwudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnKSBmb3JtYXR0ZWRWYWx1ZSA9IHRydWVcbiAgICBpZiAodmFsLnRvTG93ZXJDYXNlKCkgPT09ICdmYWxzZScpIGZvcm1hdHRlZFZhbHVlID0gZmFsc2VcbiAgfVxuXG4gIGlmIChbJ2FsbCcsICdpbicsICdub3RfaW4nXS5pbmNsdWRlcyhvcGVyYXRvcikgJiYgdHlwZW9mIGZvcm1hdHRlZFZhbHVlID09PSAnc3RyaW5nJykge1xuICAgIGZvcm1hdHRlZFZhbHVlID0gY3JlYXRlQXJyYXlGcm9tQ29tbWFEZWxpbmVhdGVkKGZvcm1hdHRlZFZhbHVlKVxuXG4gICAgaWYgKGZpZWxkLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICBmb3JtYXR0ZWRWYWx1ZSA9IGZvcm1hdHRlZFZhbHVlLm1hcCgoYXJyYXlWYWwpID0+IHBhcnNlRmxvYXQoYXJyYXlWYWwpKVxuICAgIH1cbiAgfVxuXG4gIGlmIChmaWVsZC50eXBlID09PSAnbnVtYmVyJyAmJiB0eXBlb2YgZm9ybWF0dGVkVmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgZm9ybWF0dGVkVmFsdWUgPSBOdW1iZXIodmFsKVxuICB9XG5cbiAgaWYgKGZpZWxkLnR5cGUgPT09ICdkYXRlJyAmJiB0eXBlb2YgdmFsID09PSAnc3RyaW5nJykge1xuICAgIGZvcm1hdHRlZFZhbHVlID0gbmV3IERhdGUodmFsKVxuICAgIGlmIChOdW1iZXIuaXNOYU4oRGF0ZS5wYXJzZShmb3JtYXR0ZWRWYWx1ZSkpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuICB9XG5cbiAgaWYgKFsncmVsYXRpb25zaGlwJywgJ3VwbG9hZCddLmluY2x1ZGVzKGZpZWxkLnR5cGUpKSB7XG4gICAgaWYgKHZhbCA9PT0gJ251bGwnKSB7XG4gICAgICBmb3JtYXR0ZWRWYWx1ZSA9IG51bGxcbiAgICB9XG5cbiAgICBpZiAob3BlcmF0b3IgPT09ICdpbicgJiYgQXJyYXkuaXNBcnJheShmb3JtYXR0ZWRWYWx1ZSkpIHtcbiAgICAgIGZvcm1hdHRlZFZhbHVlID0gZm9ybWF0dGVkVmFsdWUucmVkdWNlKChmb3JtYXR0ZWRWYWx1ZXMsIGluVmFsKSA9PiB7XG4gICAgICAgIGNvbnN0IG5ld1ZhbHVlcyA9IFtpblZhbF1cbiAgICAgICAgaWYgKG1vbmdvb3NlLlR5cGVzLk9iamVjdElkLmlzVmFsaWQoaW5WYWwpKVxuICAgICAgICAgIG5ld1ZhbHVlcy5wdXNoKG5ldyBtb25nb29zZS5UeXBlcy5PYmplY3RJZChpblZhbCkpXG5cbiAgICAgICAgY29uc3QgcGFyc2VkTnVtYmVyID0gcGFyc2VGbG9hdChpblZhbClcbiAgICAgICAgaWYgKCFOdW1iZXIuaXNOYU4ocGFyc2VkTnVtYmVyKSkgbmV3VmFsdWVzLnB1c2gocGFyc2VkTnVtYmVyKVxuXG4gICAgICAgIHJldHVybiBbLi4uZm9ybWF0dGVkVmFsdWVzLCAuLi5uZXdWYWx1ZXNdXG4gICAgICB9LCBbXSlcbiAgICB9XG4gIH1cblxuICAvLyBTZXQgdXAgc3BlY2lmaWMgZm9ybWF0dGluZyBuZWNlc3NhcnkgYnkgb3BlcmF0b3JzXG5cbiAgaWYgKG9wZXJhdG9yID09PSAnbmVhcicpIHtcbiAgICBsZXQgbG5nXG4gICAgbGV0IGxhdFxuICAgIGxldCBtYXhEaXN0YW5jZVxuICAgIGxldCBtaW5EaXN0YW5jZVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZm9ybWF0dGVkVmFsdWUpKSB7XG4gICAgICA7W2xuZywgbGF0LCBtYXhEaXN0YW5jZSwgbWluRGlzdGFuY2VdID0gZm9ybWF0dGVkVmFsdWVcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGZvcm1hdHRlZFZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgO1tsbmcsIGxhdCwgbWF4RGlzdGFuY2UsIG1pbkRpc3RhbmNlXSA9IGNyZWF0ZUFycmF5RnJvbUNvbW1hRGVsaW5lYXRlZChmb3JtYXR0ZWRWYWx1ZSlcbiAgICB9XG5cbiAgICBpZiAobG5nID09IG51bGwgfHwgbGF0ID09IG51bGwgfHwgKG1heERpc3RhbmNlID09IG51bGwgJiYgbWluRGlzdGFuY2UgPT0gbnVsbCkpIHtcbiAgICAgIGZvcm1hdHRlZFZhbHVlID0gdW5kZWZpbmVkXG4gICAgfSBlbHNlIHtcbiAgICAgIGZvcm1hdHRlZFZhbHVlID0ge1xuICAgICAgICAkZ2VvbWV0cnk6IHsgY29vcmRpbmF0ZXM6IFtwYXJzZUZsb2F0KGxuZyksIHBhcnNlRmxvYXQobGF0KV0sIHR5cGU6ICdQb2ludCcgfSxcbiAgICAgIH1cblxuICAgICAgaWYgKG1heERpc3RhbmNlKSBmb3JtYXR0ZWRWYWx1ZS4kbWF4RGlzdGFuY2UgPSBwYXJzZUZsb2F0KG1heERpc3RhbmNlKVxuICAgICAgaWYgKG1pbkRpc3RhbmNlKSBmb3JtYXR0ZWRWYWx1ZS4kbWluRGlzdGFuY2UgPSBwYXJzZUZsb2F0KG1pbkRpc3RhbmNlKVxuICAgIH1cbiAgfVxuXG4gIGlmIChvcGVyYXRvciA9PT0gJ3dpdGhpbicgfHwgb3BlcmF0b3IgPT09ICdpbnRlcnNlY3RzJykge1xuICAgIGZvcm1hdHRlZFZhbHVlID0ge1xuICAgICAgJGdlb21ldHJ5OiBmb3JtYXR0ZWRWYWx1ZSxcbiAgICB9XG4gIH1cblxuICBpZiAocGF0aCAhPT0gJ19pZCcgfHwgKHBhdGggPT09ICdfaWQnICYmIGhhc0N1c3RvbUlEICYmIGZpZWxkLnR5cGUgPT09ICd0ZXh0JykpIHtcbiAgICBpZiAob3BlcmF0b3IgPT09ICdjb250YWlucycpIHtcbiAgICAgIGZvcm1hdHRlZFZhbHVlID0geyAkb3B0aW9uczogJ2knLCAkcmVnZXg6IGZvcm1hdHRlZFZhbHVlIH1cbiAgICB9XG4gIH1cblxuICBpZiAob3BlcmF0b3IgPT09ICdleGlzdHMnKSB7XG4gICAgZm9ybWF0dGVkVmFsdWUgPSBmb3JtYXR0ZWRWYWx1ZSA9PT0gJ3RydWUnIHx8IGZvcm1hdHRlZFZhbHVlID09PSB0cnVlXG4gIH1cblxuICByZXR1cm4gZm9ybWF0dGVkVmFsdWVcbn1cbiJdLCJuYW1lcyI6WyJzYW5pdGl6ZVF1ZXJ5VmFsdWUiLCJmaWVsZCIsImhhc0N1c3RvbUlEIiwib3BlcmF0b3IiLCJwYXRoIiwidmFsIiwiZm9ybWF0dGVkVmFsdWUiLCJzcGxpdCIsImxlbmd0aCIsImlzVmFsaWQiLCJtb25nb29zZSIsIlR5cGVzIiwiT2JqZWN0SWQiLCJ1bmRlZmluZWQiLCJ0eXBlIiwicGFyc2VkTnVtYmVyIiwicGFyc2VGbG9hdCIsIk51bWJlciIsImlzTmFOIiwidG9Mb3dlckNhc2UiLCJpbmNsdWRlcyIsImNyZWF0ZUFycmF5RnJvbUNvbW1hRGVsaW5lYXRlZCIsIm1hcCIsImFycmF5VmFsIiwiRGF0ZSIsInBhcnNlIiwiQXJyYXkiLCJpc0FycmF5IiwicmVkdWNlIiwiZm9ybWF0dGVkVmFsdWVzIiwiaW5WYWwiLCJuZXdWYWx1ZXMiLCJwdXNoIiwibG5nIiwibGF0IiwibWF4RGlzdGFuY2UiLCJtaW5EaXN0YW5jZSIsIiRnZW9tZXRyeSIsImNvb3JkaW5hdGVzIiwiJG1heERpc3RhbmNlIiwiJG1pbkRpc3RhbmNlIiwiJG9wdGlvbnMiLCIkcmVnZXgiXSwibWFwcGluZ3MiOiI7Ozs7K0JBYWFBOzs7ZUFBQUE7OztpRUFYUTsyQkFDMEI7Ozs7OztBQVV4QyxNQUFNQSxxQkFBcUIsQ0FBQyxFQUNqQ0MsS0FBSyxFQUNMQyxXQUFXLEVBQ1hDLFFBQVEsRUFDUkMsSUFBSSxFQUNKQyxHQUFHLEVBQ29CO0lBQ3ZCLElBQUlDLGlCQUFpQkQ7SUFFckIseUJBQXlCO0lBQ3pCLElBQUlELFNBQVMsU0FBUyxPQUFPQyxRQUFRLFlBQVlBLElBQUlFLEtBQUssQ0FBQyxLQUFLQyxNQUFN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