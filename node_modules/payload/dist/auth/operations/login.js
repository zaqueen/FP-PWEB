"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return _default;
    }
});
const _jsonwebtoken = /*#__PURE__*/ _interop_require_default(require("jsonwebtoken"));
const _utils = require("../../collections/operations/utils");
const _errors = require("../../errors");
const _afterRead = require("../../fields/hooks/afterRead");
const _commitTransaction = require("../../utilities/commitTransaction");
const _getCookieExpiration = /*#__PURE__*/ _interop_require_default(require("../../utilities/getCookieExpiration"));
const _initTransaction = require("../../utilities/initTransaction");
const _killTransaction = require("../../utilities/killTransaction");
const _sanitizeInternalFields = /*#__PURE__*/ _interop_require_default(require("../../utilities/sanitizeInternalFields"));
const _isLocked = /*#__PURE__*/ _interop_require_default(require("../isLocked"));
const _authenticate = require("../strategies/local/authenticate");
const _incrementLoginAttempts = require("../strategies/local/incrementLoginAttempts");
const _getFieldsToSign = require("./getFieldsToSign");
const _unlock = /*#__PURE__*/ _interop_require_default(require("./unlock"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
async function login(incomingArgs) {
    let args = incomingArgs;
    // /////////////////////////////////////
    // beforeOperation - Collection
    // /////////////////////////////////////
    await args.collection.config.hooks.beforeOperation.reduce(async (priorHook, hook)=>{
        await priorHook;
        args = await hook({
            args,
            collection: args.collection?.config,
            context: args.req.context,
            operation: 'login'
        }) || args;
    }, Promise.resolve());
    const { collection: { config: collectionConfig }, data, depth, overrideAccess, req, req: { payload, payload: { config, secret } }, showHiddenFields } = args;
    try {
        const shouldCommit = await (0, _initTransaction.initTransaction)(req);
        // /////////////////////////////////////
        // Login
        // /////////////////////////////////////
        const { email: unsanitizedEmail, password } = data;
        const email = unsanitizedEmail ? unsanitizedEmail.toLowerCase().trim() : null;
        let user = await payload.db.findOne({
            collection: collectionConfig.slug,
            req,
            where: {
                email: {
                    equals: email.toLowerCase()
                }
            }
        });
        if (!user || args.collection.config.auth.verify && user._verified === false) {
            throw new _errors.AuthenticationError(req.t);
        }
        if (user && (0, _isLocked.default)(user.lockUntil)) {
            throw new _errors.LockedAuth(req.t);
        }
        const authResult = await (0, _authenticate.authenticateLocalStrategy)({
            doc: user,
            password
        });
        user = (0, _sanitizeInternalFields.default)(user);
        const maxLoginAttemptsEnabled = args.collection.config.auth.maxLoginAttempts > 0;
        if (!authResult) {
            if (maxLoginAttemptsEnabled) {
                await (0, _incrementLoginAttempts.incrementLoginAttempts)({
                    collection: collectionConfig,
                    doc: user,
                    payload: req.payload,
                    req
                });
            }
            throw new _errors.AuthenticationError(req.t);
        }
        if (maxLoginAttemptsEnabled) {
            await (0, _unlock.default)({
                collection: {
                    config: collectionConfig
                },
                data,
                overrideAccess: true,
                req
            });
        }
        const fieldsToSign = (0, _getFieldsToSign.getFieldsToSign)({
            collectionConfig,
            email,
            user
        });
        await collectionConfig.hooks.beforeLogin.reduce(async (priorHook, hook)=>{
            await priorHook;
            user = await hook({
                collection: args.collection?.config,
                context: args.req.context,
                req: args.req,
                user
            }) || user;
        }, Promise.resolve());
        const token = _jsonwebtoken.default.sign(fieldsToSign, secret, {
            expiresIn: collectionConfig.auth.tokenExpiration
        });
        if (args.res) {
            const cookieOptions = {
                domain: undefined,
                expires: (0, _getCookieExpiration.default)(collectionConfig.auth.tokenExpiration),
                httpOnly: true,
                path: '/',
                sameSite: collectionConfig.auth.cookies.sameSite,
                secure: collectionConfig.auth.cookies.secure
            };
            if (collectionConfig.auth.cookies.domain) cookieOptions.domain = collectionConfig.auth.cookies.domain;
            args.res.cookie(`${config.cookiePrefix}-token`, token, cookieOptions);
        }
        req.user = user;
        // /////////////////////////////////////
        // afterLogin - Collection
        // /////////////////////////////////////
        await collectionConfig.hooks.afterLogin.reduce(async (priorHook, hook)=>{
            await priorHook;
            user = await hook({
                collection: args.collection?.config,
                context: args.req.context,
                req: args.req,
                token,
                user
            }) || user;
        }, Promise.resolve());
        // /////////////////////////////////////
        // afterRead - Fields
        // /////////////////////////////////////
        user = await (0, _afterRead.afterRead)({
            collection: collectionConfig,
            context: req.context,
            depth,
            doc: user,
            global: null,
            overrideAccess,
            req,
            showHiddenFields
        });
        // /////////////////////////////////////
        // afterRead - Collection
        // /////////////////////////////////////
        await collectionConfig.hooks.afterRead.reduce(async (priorHook, hook)=>{
            await priorHook;
            user = await hook({
                collection: args.collection?.config,
                context: req.context,
                doc: user,
                req
            }) || user;
        }, Promise.resolve());
        // /////////////////////////////////////
        // afterRead - Collection
        // /////////////////////////////////////
        await collectionConfig.hooks.afterRead.reduce(async (priorHook, hook)=>{
            await priorHook;
            user = await hook({
                collection: args.collection?.config,
                context: req.context,
                doc: user,
                req
            }) || user;
        }, Promise.resolve());
        let result = {
            exp: _jsonwebtoken.default.decode(token).exp,
            token,
            user
        };
        // /////////////////////////////////////
        // afterOperation - Collection
        // /////////////////////////////////////
        result = await (0, _utils.buildAfterOperation)({
            args,
            collection: args.collection?.config,
            operation: 'login',
            result
        });
        if (collectionConfig.auth.removeTokenFromResponses) {
            delete result.token;
        }
        // /////////////////////////////////////
        // Return results
        // /////////////////////////////////////
        if (shouldCommit) await (0, _commitTransaction.commitTransaction)(req);
        return result;
    } catch (error) {
        await (0, _killTransaction.killTransaction)(req);
        throw error;
    }
}
const _default = login;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hdXRoL29wZXJhdGlvbnMvbG9naW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDb29raWVPcHRpb25zLCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnXG5cbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJ1xuXG5pbXBvcnQgdHlwZSB7IEdlbmVyYXRlZFR5cGVzIH0gZnJvbSAnLi4vLi4vJ1xuaW1wb3J0IHR5cGUgeyBDb2xsZWN0aW9uIH0gZnJvbSAnLi4vLi4vY29sbGVjdGlvbnMvY29uZmlnL3R5cGVzJ1xuaW1wb3J0IHR5cGUgeyBQYXlsb2FkUmVxdWVzdCB9IGZyb20gJy4uLy4uL2V4cHJlc3MvdHlwZXMnXG5pbXBvcnQgdHlwZSB7IFVzZXIgfSBmcm9tICcuLi90eXBlcydcblxuaW1wb3J0IHsgYnVpbGRBZnRlck9wZXJhdGlvbiB9IGZyb20gJy4uLy4uL2NvbGxlY3Rpb25zL29wZXJhdGlvbnMvdXRpbHMnXG5pbXBvcnQgeyBBdXRoZW50aWNhdGlvbkVycm9yLCBMb2NrZWRBdXRoIH0gZnJvbSAnLi4vLi4vZXJyb3JzJ1xuaW1wb3J0IHsgYWZ0ZXJSZWFkIH0gZnJvbSAnLi4vLi4vZmllbGRzL2hvb2tzL2FmdGVyUmVhZCdcbmltcG9ydCB7IGNvbW1pdFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2NvbW1pdFRyYW5zYWN0aW9uJ1xuaW1wb3J0IGdldENvb2tpZUV4cGlyYXRpb24gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2dldENvb2tpZUV4cGlyYXRpb24nXG5pbXBvcnQgeyBpbml0VHJhbnNhY3Rpb24gfSBmcm9tICcuLi8uLi91dGlsaXRpZXMvaW5pdFRyYW5zYWN0aW9uJ1xuaW1wb3J0IHsga2lsbFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2tpbGxUcmFuc2FjdGlvbidcbmltcG9ydCBzYW5pdGl6ZUludGVybmFsRmllbGRzIGZyb20gJy4uLy4uL3V0aWxpdGllcy9zYW5pdGl6ZUludGVybmFsRmllbGRzJ1xuaW1wb3J0IGlzTG9ja2VkIGZyb20gJy4uL2lzTG9ja2VkJ1xuaW1wb3J0IHsgYXV0aGVudGljYXRlTG9jYWxTdHJhdGVneSB9IGZyb20gJy4uL3N0cmF0ZWdpZXMvbG9jYWwvYXV0aGVudGljYXRlJ1xuaW1wb3J0IHsgaW5jcmVtZW50TG9naW5BdHRlbXB0cyB9IGZyb20gJy4uL3N0cmF0ZWdpZXMvbG9jYWwvaW5jcmVtZW50TG9naW5BdHRlbXB0cydcbmltcG9ydCB7IGdldEZpZWxkc1RvU2lnbiB9IGZyb20gJy4vZ2V0RmllbGRzVG9TaWduJ1xuaW1wb3J0IHVubG9jayBmcm9tICcuL3VubG9jaydcblxuZXhwb3J0IHR5cGUgUmVzdWx0ID0ge1xuICBleHA/OiBudW1iZXJcbiAgdG9rZW4/OiBzdHJpbmdcbiAgdXNlcj86IFVzZXJcbn1cblxuZXhwb3J0IHR5cGUgQXJndW1lbnRzID0ge1xuICBjb2xsZWN0aW9uOiBDb2xsZWN0aW9uXG4gIGRhdGE6IHtcbiAgICBlbWFpbDogc3RyaW5nXG4gICAgcGFzc3dvcmQ6IHN0cmluZ1xuICB9XG4gIGRlcHRoPzogbnVtYmVyXG4gIG92ZXJyaWRlQWNjZXNzPzogYm9vbGVhblxuICByZXE6IFBheWxvYWRSZXF1ZXN0XG4gIHJlcz86IFJlc3BvbnNlXG4gIHNob3dIaWRkZW5GaWVsZHM/OiBib29sZWFuXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvZ2luPFRTbHVnIGV4dGVuZHMga2V5b2YgR2VuZXJhdGVkVHlwZXNbJ2NvbGxlY3Rpb25zJ10+KFxuICBpbmNvbWluZ0FyZ3M6IEFyZ3VtZW50cyxcbik6IFByb21pc2U8UmVzdWx0ICYgeyB1c2VyOiBHZW5lcmF0ZWRUeXBlc1snY29sbGVjdGlvbnMnXVtUU2x1Z10gfT4ge1xuICBsZXQgYXJncyA9IGluY29taW5nQXJnc1xuXG4gIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gYmVmb3JlT3BlcmF0aW9uIC0gQ29sbGVjdGlvblxuICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgYXdhaXQgYXJncy5jb2xsZWN0aW9uLmNvbmZpZy5ob29rcy5iZWZvcmVPcGVyYXRpb24ucmVkdWNlKGFzeW5jIChwcmlvckhvb2ssIGhvb2spID0+IHtcbiAgICBhd2FpdCBwcmlvckhvb2tcblxuICAgIGFyZ3MgPVxuICAgICAgKGF3YWl0IGhvb2soe1xuICAgICAgICBhcmdzLFxuICAgICAgICBjb2xsZWN0aW9uOiBhcmdzLmNvbGxlY3Rpb24/LmNvbmZpZyxcbiAgICAgICAgY29udGV4dDogYXJncy5yZXEuY29udGV4dCxcbiAgICAgICAgb3BlcmF0aW9uOiAnbG9naW4nLFxuICAgICAgfSkpIHx8IGFyZ3NcbiAgfSwgUHJvbWlzZS5yZXNvbHZlKCkpXG5cbiAgY29uc3Qge1xuICAgIGNvbGxlY3Rpb246IHsgY29uZmlnOiBjb2xsZWN0aW9uQ29uZmlnIH0sXG4gICAgZGF0YSxcbiAgICBkZXB0aCxcbiAgICBvdmVycmlkZUFjY2VzcyxcbiAgICByZXEsXG4gICAgcmVxOiB7XG4gICAgICBwYXlsb2FkLFxuICAgICAgcGF5bG9hZDogeyBjb25maWcsIHNlY3JldCB9LFxuICAgIH0sXG4gICAgc2hvd0hpZGRlbkZpZWxkcyxcbiAgfSA9IGFyZ3NcblxuICB0cnkge1xuICAgIGNvbnN0IHNob3VsZENvbW1pdCA9IGF3YWl0IGluaXRUcmFuc2FjdGlvbihyZXEpXG5cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gTG9naW5cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBjb25zdCB7IGVtYWlsOiB1bnNhbml0aXplZEVtYWlsLCBwYXNzd29yZCB9ID0gZGF0YVxuXG4gICAgY29uc3QgZW1haWwgPSB1bnNhbml0aXplZEVtYWlsID8gdW5zYW5pdGl6ZWRFbWFpbC50b0xvd2VyQ2FzZSgpLnRyaW0oKSA6IG51bGxcblxuICAgIGxldCB1c2VyID0gYXdhaXQgcGF5bG9hZC5kYi5maW5kT25lPGFueT4oe1xuICAgICAgY29sbGVjdGlvbjogY29sbGVjdGlvbkNvbmZpZy5zbHVnLFxuICAgICAgcmVxLFxuICAgICAgd2hlcmU6IHsgZW1haWw6IHsgZXF1YWxzOiBlbWFpbC50b0xvd2VyQ2FzZSgpIH0gfSxcbiAgICB9KVxuXG4gICAgaWYgKCF1c2VyIHx8IChhcmdzLmNvbGxlY3Rpb24uY29uZmlnLmF1dGgudmVyaWZ5ICYmIHVzZXIuX3ZlcmlmaWVkID09PSBmYWxzZSkpIHtcbiAgICAgIHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkVycm9yKHJlcS50KVxuICAgIH1cblxuICAgIGlmICh1c2VyICYmIGlzTG9ja2VkKHVzZXIubG9ja1VudGlsKSkge1xuICAgICAgdGhyb3cgbmV3IExvY2tlZEF1dGgocmVxLnQpXG4gICAgfVxuXG4gICAgY29uc3QgYXV0aFJlc3VsdCA9IGF3YWl0IGF1dGhlbnRpY2F0ZUxvY2FsU3RyYXRlZ3koeyBkb2M6IHVzZXIsIHBhc3N3b3JkIH0pXG5cbiAgICB1c2VyID0gc2FuaXRpemVJbnRlcm5hbEZpZWxkcyh1c2VyKVxuXG4gICAgY29uc3QgbWF4TG9naW5BdHRlbXB0c0VuYWJsZWQgPSBhcmdzLmNvbGxlY3Rpb24uY29uZmlnLmF1dGgubWF4TG9naW5BdHRlbXB0cyA+IDBcblxuICAgIGlmICghYXV0aFJlc3VsdCkge1xuICAgICAgaWYgKG1heExvZ2luQXR0ZW1wdHNFbmFibGVkKSB7XG4gICAgICAgIGF3YWl0IGluY3JlbWVudExvZ2luQXR0ZW1wdHMoe1xuICAgICAgICAgIGNvbGxlY3Rpb246IGNvbGxlY3Rpb25Db25maWcsXG4gICAgICAgICAgZG9jOiB1c2VyLFxuICAgICAgICAgIHBheWxvYWQ6IHJlcS5wYXlsb2FkLFxuICAgICAgICAgIHJlcSxcbiAgICAgICAgfSlcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IEF1dGhlbnRpY2F0aW9uRXJyb3IocmVxLnQpXG4gICAgfVxuXG4gICAgaWYgKG1heExvZ2luQXR0ZW1wdHNFbmFibGVkKSB7XG4gICAgICBhd2FpdCB1bmxvY2soe1xuICAgICAgICBjb2xsZWN0aW9uOiB7XG4gICAgICAgICAgY29uZmlnOiBjb2xsZWN0aW9uQ29uZmlnLFxuICAgICAgICB9LFxuICAgICAgICBkYXRhLFxuICAgICAgICBvdmVycmlkZUFjY2VzczogdHJ1ZSxcbiAgICAgICAgcmVxLFxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBmaWVsZHNUb1NpZ24gPSBnZXRGaWVsZHNUb1NpZ24oe1xuICAgICAgY29sbGVjdGlvbkNvbmZpZyxcbiAgICAgIGVtYWlsLFxuICAgICAgdXNlcixcbiAgICB9KVxuXG4gICAgYXdhaXQgY29sbGVjdGlvbkNvbmZpZy5ob29rcy5iZWZvcmVMb2dpbi5yZWR1Y2UoYXN5bmMgKHByaW9ySG9vaywgaG9vaykgPT4ge1xuICAgICAgYXdhaXQgcHJpb3JIb29rXG5cbiAgICAgIHVzZXIgPVxuICAgICAgICAoYXdhaXQgaG9vayh7XG4gICAgICAgICAgY29sbGVjdGlvbjogYXJncy5jb2xsZWN0aW9uPy5jb25maWcsXG4gICAgICAgICAgY29udGV4dDogYXJncy5yZXEuY29udGV4dCxcbiAgICAgICAgICByZXE6IGFyZ3MucmVxLFxuICAgICAgICAgIHVzZXIsXG4gICAgICAgIH0pKSB8fCB1c2VyXG4gICAgfSwgUHJvbWlzZS5yZXNvbHZlKCkpXG5cbiAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKGZpZWxkc1RvU2lnbiwgc2VjcmV0LCB7XG4gICAgICBleHBpcmVzSW46IGNvbGxlY3Rpb25Db25maWcuYXV0aC50b2tlbkV4cGlyYXRpb24sXG4gICAgfSlcblxuICAgIGlmIChhcmdzLnJlcykge1xuICAgICAgY29uc3QgY29va2llT3B0aW9uczogQ29va2llT3B0aW9ucyA9IHtcbiAgICAgICAgZG9tYWluOiB1bmRlZmluZWQsXG4gICAgICAgIGV4cGlyZXM6IGdldENvb2tpZUV4cGlyYXRpb24oY29sbGVjdGlvbkNvbmZpZy5hdXRoLnRva2VuRXhwaXJhdGlvbiksXG4gICAgICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgICAgICBwYXRoOiAnLycsXG4gICAgICAgIHNhbWVTaXRlOiBjb2xsZWN0aW9uQ29uZmlnLmF1dGguY29va2llcy5zYW1lU2l0ZSxcbiAgICAgICAgc2VjdXJlOiBjb2xsZWN0aW9uQ29uZmlnLmF1dGguY29va2llcy5zZWN1cmUsXG4gICAgICB9XG5cbiAgICAgIGlmIChjb2xsZWN0aW9uQ29uZmlnLmF1dGguY29va2llcy5kb21haW4pXG4gICAgICAgIGNvb2tpZU9wdGlvbnMuZG9tYWluID0gY29sbGVjdGlvbkNvbmZpZy5hdXRoLmNvb2tpZXMuZG9tYWluXG5cbiAgICAgIGFyZ3MucmVzLmNvb2tpZShgJHtjb25maWcuY29va2llUHJlZml4fS10b2tlbmAsIHRva2VuLCBjb29raWVPcHRpb25zKVxuICAgIH1cblxuICAgIHJlcS51c2VyID0gdXNlclxuXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIGFmdGVyTG9naW4gLSBDb2xsZWN0aW9uXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgYXdhaXQgY29sbGVjdGlvbkNvbmZpZy5ob29rcy5hZnRlckxvZ2luLnJlZHVjZShhc3luYyAocHJpb3JIb29rLCBob29rKSA9PiB7XG4gICAgICBhd2FpdCBwcmlvckhvb2tcblxuICAgICAgdXNlciA9XG4gICAgICAgIChhd2FpdCBob29rKHtcbiAgICAgICAgICBjb2xsZWN0aW9uOiBhcmdzLmNvbGxlY3Rpb24/LmNvbmZpZyxcbiAgICAgICAgICBjb250ZXh0OiBhcmdzLnJlcS5jb250ZXh0LFxuICAgICAgICAgIHJlcTogYXJncy5yZXEsXG4gICAgICAgICAgdG9rZW4sXG4gICAgICAgICAgdXNlcixcbiAgICAgICAgfSkpIHx8IHVzZXJcbiAgICB9LCBQcm9taXNlLnJlc29sdmUoKSlcblxuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBhZnRlclJlYWQgLSBGaWVsZHNcbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICB1c2VyID0gYXdhaXQgYWZ0ZXJSZWFkKHtcbiAgICAgIGNvbGxlY3Rpb246IGNvbGxlY3Rpb25Db25maWcsXG4gICAgICBjb250ZXh0OiByZXEuY29udGV4dCxcbiAgICAgIGRlcHRoLFxuICAgICAgZG9jOiB1c2VyLFxuICAgICAgZ2xvYmFsOiBudWxsLFxuICAgICAgb3ZlcnJpZGVBY2Nlc3MsXG4gICAgICByZXEsXG4gICAgICBzaG93SGlkZGVuRmllbGRzLFxuICAgIH0pXG5cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gYWZ0ZXJSZWFkIC0gQ29sbGVjdGlvblxuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGF3YWl0IGNvbGxlY3Rpb25Db25maWcuaG9va3MuYWZ0ZXJSZWFkLnJlZHVjZShhc3luYyAocHJpb3JIb29rLCBob29rKSA9PiB7XG4gICAgICBhd2FpdCBwcmlvckhvb2tcblxuICAgICAgdXNlciA9XG4gICAgICAgIChhd2FpdCBob29rKHtcbiAgICAgICAgICBjb2xsZWN0aW9uOiBhcmdzLmNvbGxlY3Rpb24/LmNvbmZpZyxcbiAgICAgICAgICBjb250ZXh0OiByZXEuY29udGV4dCxcbiAgICAgICAgICBkb2M6IHVzZXIsXG4gICAgICAgICAgcmVxLFxuICAgICAgICB9KSkgfHwgdXNlclxuICAgIH0sIFByb21pc2UucmVzb2x2ZSgpKVxuXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIGFmdGVyUmVhZCAtIENvbGxlY3Rpb25cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBhd2FpdCBjb2xsZWN0aW9uQ29uZmlnLmhvb2tzLmFmdGVyUmVhZC5yZWR1Y2UoYXN5bmMgKHByaW9ySG9vaywgaG9vaykgPT4ge1xuICAgICAgYXdhaXQgcHJpb3JIb29rXG5cbiAgICAgIHVzZXIgPVxuICAgICAgICAoYXdhaXQgaG9vayh7XG4gICAgICAgICAgY29sbGVjdGlvbjogYXJncy5jb2xsZWN0aW9uPy5jb25maWcsXG4gICAgICAgICAgY29udGV4dDogcmVxLmNvbnRleHQsXG4gICAgICAgICAgZG9jOiB1c2VyLFxuICAgICAgICAgIHJlcSxcbiAgICAgICAgfSkpIHx8IHVzZXJcbiAgICB9LCBQcm9taXNlLnJlc29sdmUoKSlcblxuICAgIGxldCByZXN1bHQ6IFJlc3VsdCAmIHsgdXNlcjogR2VuZXJhdGVkVHlwZXNbJ2NvbGxlY3Rpb25zJ11bVFNsdWddIH0gPSB7XG4gICAgICBleHA6IChqd3QuZGVjb2RlKHRva2VuKSBhcyBqd3QuSnd0UGF5bG9hZCkuZXhwLFxuICAgICAgdG9rZW4sXG4gICAgICB1c2VyLFxuICAgIH1cblxuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBhZnRlck9wZXJhdGlvbiAtIENvbGxlY3Rpb25cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICByZXN1bHQgPSBhd2FpdCBidWlsZEFmdGVyT3BlcmF0aW9uPEdlbmVyYXRlZFR5cGVzWydjb2xsZWN0aW9ucyddW1RTbHVnXT4oe1xuICAgICAgYXJncyxcbiAgICAgIGNvbGxlY3Rpb246IGFyZ3MuY29sbGVjdGlvbj8uY29uZmlnLFxuICAgICAgb3BlcmF0aW9uOiAnbG9naW4nLFxuICAgICAgcmVzdWx0LFxuICAgIH0pXG5cbiAgICBpZiAoY29sbGVjdGlvbkNvbmZpZy5hdXRoLnJlbW92ZVRva2VuRnJvbVJlc3BvbnNlcykge1xuICAgICAgZGVsZXRlIHJlc3VsdC50b2tlblxuICAgIH1cblxuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBSZXR1cm4gcmVzdWx0c1xuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChzaG91bGRDb21taXQpIGF3YWl0IGNvbW1pdFRyYW5zYWN0aW9uKHJlcSlcblxuICAgIHJldHVybiByZXN1bHRcbiAgfSBjYXRjaCAoZXJyb3I6IHVua25vd24pIHtcbiAgICBhd2FpdCBraWxsVHJhbnNhY3Rpb24ocmVxKVxuICAgIHRocm93IGVycm9yXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgbG9naW5cbiJdLCJuYW1lcyI6WyJsb2dpbiIsImluY29taW5nQXJncyIsImFyZ3MiLCJjb2xsZWN0aW9uIiwiY29uZmlnIiwiaG9va3MiLCJiZWZvcmVPcGVyYXRpb24iLCJyZWR1Y2UiLCJwcmlvckhvb2siLCJob29rIiwiY29udGV4dCIsInJlcSIsIm9wZXJhdGlvbiIsIlByb21pc2UiLCJyZXNvbHZlIiwiY29sbGVjdGlvbkNvbmZpZyIsImRhdGEiLCJkZXB0aCIsIm92ZXJyaWRlQWNjZXNzIiwicGF5bG9hZCIsInNlY3JldCIsInNob3dIaWRkZW5GaWVsZHMiLCJzaG91bGRDb21taXQiLCJpbml0VHJhbnNhY3Rpb24iLCJlbWFpbCIsInVuc2FuaXRpemVkRW1haWwiLCJwYXNzd29yZCIsInRvTG93ZXJDYXNlIiwidHJpbSIsInVzZXIiLCJkYiIsImZpbmRPbmUiLCJzbHVnIiwid2hlcmUiLCJlcXVhbHMiLCJhdXRoIiwidmVyaWZ5IiwiX3ZlcmlmaWVkIiwiQXV0aGVudGljYXRpb25FcnJvciIsInQiLCJpc0xvY2tlZCIsImxvY2tVbnRpbCIsIkxvY2tlZEF1dGgiLCJhdXRoUmVzdWx0IiwiYXV0aGVudGljYXRlTG9jYWxTdHJhdGVneSIsImRvYyIsInNhbml0aXplSW50ZXJuYWxGaWVsZHMiLCJtYXhMb2dpbkF0dGVtcHRzRW5hYmxlZCIsIm1heExvZ2luQXR0ZW1wdHMiLCJpbmNyZW1lbnRMb2dpbkF0dGVtcHRzIiwidW5sb2NrIiwiZmllbGRzVG9TaWduIiwiZ2V0RmllbGRzVG9TaWduIiwiYmVmb3JlTG9naW4iLCJ0b2tlbiIsImp3dCIsInNpZ24iLCJleHBpcmVzSW4iLCJ0b2tlbkV4cGlyYXRpb24iLCJyZXMiLCJjb29raWVPcHRpb25zIiwiZG9tYWluIiwidW5kZWZpbmVkIiwiZXhwaXJlcyIsImdldENvb2tpZUV4cGlyYXRpb24iLCJodHRwT25seSIsInBhdGgiLCJzYW1lU2l0ZSIsImNvb2tpZXMiLCJzZWN1cmUiLCJjb29raWUiLCJjb29raWVQcmVmaXgiLCJhZnRlckxvZ2luIiwiYWZ0ZXJSZWFkIiwiZ2xvYmFsIiwicmVzdWx0IiwiZXhwIiwiZGVjb2RlIiwiYnVpbGRBZnRlck9wZXJhdGlvbiIsInJlbW92ZVRva2VuRnJvbVJlc3BvbnNlcyIsImNvbW1pdFRyYW5zYWN0aW9uIiwiZXJyb3IiLCJraWxsVHJhbnNhY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7K0JBNlFBOzs7ZUFBQTs7O3FFQTNRZ0I7dUJBT29CO3dCQUNZOzJCQUN0QjttQ0FDUTs0RUFDRjtpQ0FDQTtpQ0FDQTsrRUFDRztpRUFDZDs4QkFDcUI7d0NBQ0g7aUNBQ1A7K0RBQ2I7Ozs7OztBQXFCbkIsZUFBZUEsTUFDYkMsWUFBdUI7SUFFdkIsSUFBSUMsT0FBT0Q7SUFFWCx3Q0FBd0M7SUFDeEMsK0JBQStCO0lBQy9CLHdDQUF3QztJQUV4QyxNQUFNQyxLQUFLQyxVQUFVLENBQUNDLE1BQU0sQ0FBQ0MsS0FBSyxDQUFDQyxlQUFlLENBQUNDLE1BQU0sQ0FBQyxPQUFPQyxXQUFXQztRQUMxRSxNQUFNRDtRQUVOTixPQUNFLEFBQUMsTUFBTU8sS0FBSztZQUNWUDtZQUNBQyxZQUFZRCxLQUFLQyxVQUFVLEVBQUVDO1lBQzdCTSxTQUFTUixLQUFLUyxHQUFHLENBQUNELE9BQU87WUFDekJFLFdBQVc7UUFDYixNQUFPVjtJQUNYLEdBQUdXLFFBQVFDLE9BQU87SUFFbEIsTUFBTSxFQUNKWCxZ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