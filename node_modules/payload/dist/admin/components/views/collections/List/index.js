"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return _default;
    }
});
const _qs = /*#__PURE__*/ _interop_require_default(require("qs"));
const _react = /*#__PURE__*/ _interop_require_wildcard(require("react"));
const _reacti18next = require("react-i18next");
const _reactrouterdom = require("react-router-dom");
const _uuid = require("uuid");
const _usePayloadAPI = /*#__PURE__*/ _interop_require_default(require("../../../../hooks/usePayloadAPI"));
const _useUseAsTitle = require("../../../../hooks/useUseAsTitle");
const _StepNav = require("../../../elements/StepNav");
const _TableColumns = require("../../../elements/TableColumns");
const _Auth = require("../../../utilities/Auth");
const _Config = require("../../../utilities/Config");
const _Preferences = require("../../../utilities/Preferences");
const _RenderCustomComponent = /*#__PURE__*/ _interop_require_default(require("../../../utilities/RenderCustomComponent"));
const _SearchParams = require("../../../utilities/SearchParams");
const _Default = /*#__PURE__*/ _interop_require_default(require("./Default"));
const _formatFields = /*#__PURE__*/ _interop_require_default(require("./formatFields"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
function _getRequireWildcardCache(nodeInterop) {
    if (typeof WeakMap !== "function") return null;
    var cacheBabelInterop = new WeakMap();
    var cacheNodeInterop = new WeakMap();
    return (_getRequireWildcardCache = function(nodeInterop) {
        return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
    })(nodeInterop);
}
function _interop_require_wildcard(obj, nodeInterop) {
    if (!nodeInterop && obj && obj.__esModule) {
        return obj;
    }
    if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
        return {
            default: obj
        };
    }
    var cache = _getRequireWildcardCache(nodeInterop);
    if (cache && cache.has(obj)) {
        return cache.get(obj);
    }
    var newObj = {};
    var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;
    for(var key in obj){
        if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
            var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;
            if (desc && (desc.get || desc.set)) {
                Object.defineProperty(newObj, key, desc);
            } else {
                newObj[key] = obj[key];
            }
        }
    }
    newObj.default = obj;
    if (cache) {
        cache.set(obj, newObj);
    }
    return newObj;
}
const hoistQueryParamsToAnd = (where, queryParams)=>{
    if ('and' in where) {
        where.and.push(queryParams);
    } else if ('or' in where) {
        where = {
            and: [
                where,
                queryParams
            ]
        };
    } else {
        where = {
            and: [
                where,
                queryParams
            ]
        };
    }
    return where;
};
/**
 * The ListView component is table which lists the collection's documents.
 * The default list view can be found at the {@link DefaultList} component.
 * Users can also create pass their own custom list view component instead
 * of using the default one.
 */ const ListView = (props)=>{
    const { collection, collection: { admin: { components: { views: { List: CustomList } = {} } = {}, listSearchableFields, pagination: { defaultLimit } }, labels: { plural }, slug } } = props;
    const { routes: { admin, api }, serverURL } = (0, _Config.useConfig)();
    const preferenceKey = `${collection.slug}-list`;
    const { permissions } = (0, _Auth.useAuth)();
    const { setStepNav } = (0, _StepNav.useStepNav)();
    const { getPreference, setPreference } = (0, _Preferences.usePreferences)();
    const { limit, page, search, sort, where } = (0, _SearchParams.useSearchParams)();
    const history = (0, _reactrouterdom.useHistory)();
    const { t } = (0, _reacti18next.useTranslation)('general');
    const [fetchURL, setFetchURL] = (0, _react.useState)('');
    const [fields] = (0, _react.useState)(()=>(0, _formatFields.default)(collection));
    const collectionPermissions = permissions?.collections?.[slug];
    const hasCreatePermission = collectionPermissions?.create?.permission;
    const newDocumentURL = `${admin}/collections/${slug}/create`;
    const [{ data }, { setParams }] = (0, _usePayloadAPI.default)(fetchURL, {
        initialParams: {
            page: 1
        }
    });
    const titleField = (0, _useUseAsTitle.useUseTitleField)(collection);
    (0, _react.useEffect)(()=>{
        setStepNav([
            {
                label: plural
            }
        ]);
    }, [
        setStepNav,
        plural
    ]);
    // /////////////////////////////////////
    // Set up Payload REST API query params
    // /////////////////////////////////////
    const resetParams = (0, _react.useCallback)((overrides = {})=>{
        const params = {
            depth: 0,
            draft: 'true',
            limit,
            page: overrides?.page,
            search: overrides?.search,
            sort: overrides?.sort,
            where: overrides?.where || {}
        };
        if (page) params.page = page;
        if (sort) params.sort = sort;
        if (where) params.where = where;
        params.invoke = (0, _uuid.v4)();
        if (search) {
            let copyOfWhere = {
                ...where || {}
            };
            const searchAsConditions = (listSearchableFields || [
                titleField?.name
            ]).map((fieldName)=>{
                return {
                    [fieldName]: {
                        like: search
                    }
                };
            }, []);
            if (searchAsConditions.length > 0) {
                const conditionalSearchFields = {
                    or: [
                        ...searchAsConditions
                    ]
                };
                copyOfWhere = hoistQueryParamsToAnd(copyOfWhere, conditionalSearchFields);
            }
            params.where = copyOfWhere;
        }
        setParams(params);
    }, [
        limit,
        page,
        setParams,
        sort,
        where,
        search,
        listSearchableFields,
        titleField?.name
    ]);
    (0, _react.useEffect)(()=>{
        // Performance enhancement
        // Setting the Fetch URL this way
        // prevents a double-fetch
        setFetchURL(`${serverURL}${api}/${slug}`);
        resetParams();
    }, [
        api,
        resetParams,
        serverURL,
        slug
    ]);
    // /////////////////////////////////////
    // Fetch preferences on first load
    // /////////////////////////////////////
    (0, _react.useEffect)(()=>{
        (async ()=>{
            const currentPreferences = await getPreference(preferenceKey);
            const params = _qs.default.parse(history.location.search, {
                depth: 0,
                ignoreQueryPrefix: true
            });
            const search = {
                ...params,
                limit: params?.limit || currentPreferences?.limit || defaultLimit,
                sort: params?.sort || currentPreferences?.sort
            };
            const newSearchQuery = _qs.default.stringify(search, {
                addQueryPrefix: true
            });
            if (newSearchQuery.length > 1) {
                history.replace({
                    search: newSearchQuery
                });
            }
        })();
    }, [
        collection,
        getPreference,
        preferenceKey,
        history,
        t,
        defaultLimit
    ]);
    // /////////////////////////////////////
    // Set preferences on change
    // /////////////////////////////////////
    (0, _react.useEffect)(()=>{
        void setPreference(preferenceKey, {
            sort
        }, true);
    }, [
        sort,
        preferenceKey,
        setPreference
    ]);
    (0, _react.useEffect)(()=>{
        void setPreference(preferenceKey, {
            limit
        }, true);
    }, [
        limit,
        preferenceKey,
        setPreference
    ]);
    // /////////////////////////////////////
    // Prevent going beyond page limit
    // /////////////////////////////////////
    (0, _react.useEffect)(()=>{
        if (data?.totalDocs && data.pagingCounter > data.totalDocs) {
            const params = _qs.default.parse(history.location.search, {
                depth: 0,
                ignoreQueryPrefix: true
            });
            const newSearchQuery = _qs.default.stringify({
                ...params,
                page: data.totalPages
            }, {
                addQueryPrefix: true
            });
            history.replace({
                search: newSearchQuery
            });
        }
    }, [
        data,
        history,
        resetParams
    ]);
    return /*#__PURE__*/ _react.default.createElement(_TableColumns.TableColumnsProvider, {
        collection: collection
    }, /*#__PURE__*/ _react.default.createElement(_RenderCustomComponent.default, {
        CustomComponent: CustomList,
        DefaultComponent: _Default.default,
        componentProps: {
            collection: {
                ...collection,
                fields
            },
            data,
            hasCreatePermission,
            limit: limit || defaultLimit,
            newDocumentURL,
            resetParams,
            titleField
        }
    }));
};
const _default = ListView;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9hZG1pbi9jb21wb25lbnRzL3ZpZXdzL2NvbGxlY3Rpb25zL0xpc3QvaW5kZXgudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBxdWVyeVN0cmluZyBmcm9tICdxcydcbmltcG9ydCBSZWFjdCwgeyB1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHsgdXNlVHJhbnNsYXRpb24gfSBmcm9tICdyZWFjdC1pMThuZXh0J1xuaW1wb3J0IHsgdXNlSGlzdG9yeSB9IGZyb20gJ3JlYWN0LXJvdXRlci1kb20nXG5pbXBvcnQgeyB2NCBhcyB1dWlkIH0gZnJvbSAndXVpZCdcblxuaW1wb3J0IHR5cGUgeyBXaGVyZSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL2V4cG9ydHMvdHlwZXMnXG5pbXBvcnQgdHlwZSB7IExpc3RJbmRleFByb3BzLCBMaXN0UHJlZmVyZW5jZXMsIFByb3BzIH0gZnJvbSAnLi90eXBlcydcblxuaW1wb3J0IHsgdHlwZSBGaWVsZCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL2ZpZWxkcy9jb25maWcvdHlwZXMnXG5pbXBvcnQgdXNlUGF5bG9hZEFQSSBmcm9tICcuLi8uLi8uLi8uLi9ob29rcy91c2VQYXlsb2FkQVBJJ1xuaW1wb3J0IHsgdXNlVXNlVGl0bGVGaWVsZCB9IGZyb20gJy4uLy4uLy4uLy4uL2hvb2tzL3VzZVVzZUFzVGl0bGUnXG5pbXBvcnQgeyB1c2VTdGVwTmF2IH0gZnJvbSAnLi4vLi4vLi4vZWxlbWVudHMvU3RlcE5hdidcbmltcG9ydCB7IFRhYmxlQ29sdW1uc1Byb3ZpZGVyIH0gZnJvbSAnLi4vLi4vLi4vZWxlbWVudHMvVGFibGVDb2x1bW5zJ1xuaW1wb3J0IHsgdXNlQXV0aCB9IGZyb20gJy4uLy4uLy4uL3V0aWxpdGllcy9BdXRoJ1xuaW1wb3J0IHsgdXNlQ29uZmlnIH0gZnJvbSAnLi4vLi4vLi4vdXRpbGl0aWVzL0NvbmZpZydcbmltcG9ydCB7IHVzZVByZWZlcmVuY2VzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbGl0aWVzL1ByZWZlcmVuY2VzJ1xuaW1wb3J0IFJlbmRlckN1c3RvbUNvbXBvbmVudCBmcm9tICcuLi8uLi8uLi91dGlsaXRpZXMvUmVuZGVyQ3VzdG9tQ29tcG9uZW50J1xuaW1wb3J0IHsgdXNlU2VhcmNoUGFyYW1zIH0gZnJvbSAnLi4vLi4vLi4vdXRpbGl0aWVzL1NlYXJjaFBhcmFtcydcbmltcG9ydCBEZWZhdWx0TGlzdCBmcm9tICcuL0RlZmF1bHQnXG5pbXBvcnQgZm9ybWF0RmllbGRzIGZyb20gJy4vZm9ybWF0RmllbGRzJ1xuXG5jb25zdCBob2lzdFF1ZXJ5UGFyYW1zVG9BbmQgPSAod2hlcmU6IFdoZXJlLCBxdWVyeVBhcmFtczogV2hlcmUpID0+IHtcbiAgaWYgKCdhbmQnIGluIHdoZXJlKSB7XG4gICAgd2hlcmUuYW5kLnB1c2gocXVlcnlQYXJhbXMpXG4gIH0gZWxzZSBpZiAoJ29yJyBpbiB3aGVyZSkge1xuICAgIHdoZXJlID0ge1xuICAgICAgYW5kOiBbd2hlcmUsIHF1ZXJ5UGFyYW1zXSxcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgd2hlcmUgPSB7XG4gICAgICBhbmQ6IFt3aGVyZSwgcXVlcnlQYXJhbXNdLFxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB3aGVyZVxufVxuXG4vKipcbiAqIFRoZSBMaXN0VmlldyBjb21wb25lbnQgaXMgdGFibGUgd2hpY2ggbGlzdHMgdGhlIGNvbGxlY3Rpb24ncyBkb2N1bWVudHMuXG4gKiBUaGUgZGVmYXVsdCBsaXN0IHZpZXcgY2FuIGJlIGZvdW5kIGF0IHRoZSB7QGxpbmsgRGVmYXVsdExpc3R9IGNvbXBvbmVudC5cbiAqIFVzZXJzIGNhbiBhbHNvIGNyZWF0ZSBwYXNzIHRoZWlyIG93biBjdXN0b20gbGlzdCB2aWV3IGNvbXBvbmVudCBpbnN0ZWFkXG4gKiBvZiB1c2luZyB0aGUgZGVmYXVsdCBvbmUuXG4gKi9cbmNvbnN0IExpc3RWaWV3OiBSZWFjdC5GQzxMaXN0SW5kZXhQcm9wcz4gPSAocHJvcHMpID0+IHtcbiAgY29uc3Qge1xuICAgIGNvbGxlY3Rpb24sXG4gICAgY29sbGVjdGlvbjoge1xuICAgICAgYWRtaW46IHtcbiAgICAgICAgY29tcG9uZW50czogeyB2aWV3czogeyBMaXN0OiBDdXN0b21MaXN0IH0gPSB7fSB9ID0ge30sXG4gICAgICAgIGxpc3RTZWFyY2hhYmxlRmllbGRzLFxuICAgICAgICBwYWdpbmF0aW9uOiB7IGRlZmF1bHRMaW1pdCB9LFxuICAgICAgfSxcbiAgICAgIGxhYmVsczogeyBwbHVyYWwgfSxcbiAgICAgIHNsdWcsXG4gICAgfSxcbiAgfSA9IHByb3BzXG5cbiAgY29uc3Qge1xuICAgIHJvdXRlczogeyBhZG1pbiwgYXBpIH0sXG4gICAgc2VydmVyVVJMLFxuICB9ID0gdXNlQ29uZmlnKClcbiAgY29uc3QgcHJlZmVyZW5jZUtleSA9IGAke2NvbGxlY3Rpb24uc2x1Z30tbGlzdGBcbiAgY29uc3QgeyBwZXJtaXNzaW9ucyB9ID0gdXNlQXV0aCgpXG4gIGNvbnN0IHsgc2V0U3RlcE5hdiB9ID0gdXNlU3RlcE5hdigpXG4gIGNvbnN0IHsgZ2V0UHJlZmVyZW5jZSwgc2V0UHJlZmVyZW5jZSB9ID0gdXNlUHJlZmVyZW5jZXMoKVxuICBjb25zdCB7IGxpbWl0LCBwYWdlLCBzZWFyY2gsIHNvcnQsIHdoZXJlIH0gPSB1c2VTZWFyY2hQYXJhbXMoKVxuICBjb25zdCBoaXN0b3J5ID0gdXNlSGlzdG9yeSgpXG4gIGNvbnN0IHsgdCB9ID0gdXNlVHJhbnNsYXRpb24oJ2dlbmVyYWwnKVxuICBjb25zdCBbZmV0Y2hVUkwsIHNldEZldGNoVVJMXSA9IHVzZVN0YXRlPHN0cmluZz4oJycpXG4gIGNvbnN0IFtmaWVsZHNdID0gdXNlU3RhdGU8RmllbGRbXT4oKCkgPT4gZm9ybWF0RmllbGRzKGNvbGxlY3Rpb24pKVxuICBjb25zdCBjb2xsZWN0aW9uUGVybWlzc2lvbnMgPSBwZXJtaXNzaW9ucz8uY29sbGVjdGlvbnM/LltzbHVnXVxuICBjb25zdCBoYXNDcmVhdGVQZXJtaXNzaW9uID0gY29sbGVjdGlvblBlcm1pc3Npb25zPy5jcmVhdGU/LnBlcm1pc3Npb25cbiAgY29uc3QgbmV3RG9jdW1lbnRVUkwgPSBgJHthZG1pbn0vY29sbGVjdGlvbnMvJHtzbHVnfS9jcmVhdGVgXG4gIGNvbnN0IFt7IGRhdGEgfSwgeyBzZXRQYXJhbXMgfV0gPSB1c2VQYXlsb2FkQVBJKGZldGNoVVJMLCB7IGluaXRpYWxQYXJhbXM6IHsgcGFnZTogMSB9IH0pXG4gIGNvbnN0IHRpdGxlRmllbGQgPSB1c2VVc2VUaXRsZUZpZWxkKGNvbGxlY3Rpb24pXG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBzZXRTdGVwTmF2KFtcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IHBsdXJhbCxcbiAgICAgIH0sXG4gICAgXSlcbiAgfSwgW3NldFN0ZXBOYXYsIHBsdXJhbF0pXG5cbiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvLyBTZXQgdXAgUGF5bG9hZCBSRVNUIEFQSSBxdWVyeSBwYXJhbXNcbiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIGNvbnN0IHJlc2V0UGFyYW1zID0gdXNlQ2FsbGJhY2s8UHJvcHNbJ3Jlc2V0UGFyYW1zJ10+KFxuICAgIChvdmVycmlkZXMgPSB7fSkgPT4ge1xuICAgICAgY29uc3QgcGFyYW1zOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiAmIHsgd2hlcmU/OiBXaGVyZSB9ID0ge1xuICAgICAgICBkZXB0aDogMCxcbiAgICAgICAgZHJhZnQ6ICd0cnVlJyxcbiAgICAgICAgbGltaXQsXG4gICAgICAgIHBhZ2U6IG92ZXJyaWRlcz8ucGFnZSxcbiAgICAgICAgc2VhcmNoOiBvdmVycmlkZXM/LnNlYXJjaCxcbiAgICAgICAgc29ydDogb3ZlcnJpZGVzPy5zb3J0LFxuICAgICAgICB3aGVyZTogb3ZlcnJpZGVzPy53aGVyZSB8fCB7fSxcbiAgICAgIH1cblxuICAgICAgaWYgKHBhZ2UpIHBhcmFtcy5wYWdlID0gcGFnZVxuICAgICAgaWYgKHNvcnQpIHBhcmFtcy5zb3J0ID0gc29ydFxuICAgICAgaWYgKHdoZXJlKSBwYXJhbXMud2hlcmUgPSB3aGVyZSBhcyBXaGVyZVxuICAgICAgcGFyYW1zLmludm9rZSA9IHV1aWQoKVxuXG4gICAgICBpZiAoc2VhcmNoKSB7XG4gICAgICAgIGxldCBjb3B5T2ZXaGVyZSA9IHsgLi4uKCh3aGVyZSBhcyBXaGVyZSkgfHwge30pIH1cblxuICAgICAgICBjb25zdCBzZWFyY2hBc0NvbmRpdGlvbnMgPSAobGlzdFNlYXJjaGFibGVGaWVsZHMgfHwgW3RpdGxlRmllbGQ/Lm5hbWVdKS5tYXAoKGZpZWxkTmFtZSkgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBbZmllbGROYW1lXToge1xuICAgICAgICAgICAgICBsaWtlOiBzZWFyY2gsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH1cbiAgICAgICAgfSwgW10pXG5cbiAgICAgICAgaWYgKHNlYXJjaEFzQ29uZGl0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgY29uZGl0aW9uYWxTZWFyY2hGaWVsZHMgPSB7XG4gICAgICAgICAgICBvcjogWy4uLnNlYXJjaEFzQ29uZGl0aW9uc10sXG4gICAgICAgICAgfVxuICAgICAgICAgIGNvcHlPZldoZXJlID0gaG9pc3RRdWVyeVBhcmFtc1RvQW5kKGNvcHlPZldoZXJlLCBjb25kaXRpb25hbFNlYXJjaEZpZWxkcylcbiAgICAgICAgfVxuXG4gICAgICAgIHBhcmFtcy53aGVyZSA9IGNvcHlPZldoZXJlXG4gICAgICB9XG5cbiAgICAgIHNldFBhcmFtcyhwYXJhbXMpXG4gICAgfSxcbiAgICBbbGltaXQsIHBhZ2UsIHNldFBhcmFtcywgc29ydCwgd2hlcmUsIHNlYXJjaCwgbGlzdFNlYXJjaGFibGVGaWVsZHMsIHRpdGxlRmllbGQ/Lm5hbWVdLFxuICApXG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICAvLyBQZXJmb3JtYW5jZSBlbmhhbmNlbWVudFxuICAgIC8vIFNldHRpbmcgdGhlIEZldGNoIFVSTCB0aGlzIHdheVxuICAgIC8vIHByZXZlbnRzIGEgZG91YmxlLWZldGNoXG4gICAgc2V0RmV0Y2hVUkwoYCR7c2VydmVyVVJMfSR7YXBpfS8ke3NsdWd9YClcbiAgICByZXNldFBhcmFtcygpXG4gIH0sIFthcGksIHJlc2V0UGFyYW1zLCBzZXJ2ZXJVUkwsIHNsdWddKVxuXG4gIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gRmV0Y2ggcHJlZmVyZW5jZXMgb24gZmlyc3QgbG9hZFxuICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICA7KGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRQcmVmZXJlbmNlcyA9IGF3YWl0IGdldFByZWZlcmVuY2U8TGlzdFByZWZlcmVuY2VzPihwcmVmZXJlbmNlS2V5KVxuXG4gICAgICBjb25zdCBwYXJhbXMgPSBxdWVyeVN0cmluZy5wYXJzZShoaXN0b3J5LmxvY2F0aW9uLnNlYXJjaCwge1xuICAgICAgICBkZXB0aDogMCxcbiAgICAgICAgaWdub3JlUXVlcnlQcmVmaXg6IHRydWUsXG4gICAgICB9KVxuXG4gICAgICBjb25zdCBzZWFyY2ggPSB7XG4gICAgICAgIC4uLnBhcmFtcyxcbiAgICAgICAgbGltaXQ6IHBhcmFtcz8ubGltaXQgfHwgY3VycmVudFByZWZlcmVuY2VzPy5saW1pdCB8fCBkZWZhdWx0TGltaXQsXG4gICAgICAgIHNvcnQ6IHBhcmFtcz8uc29ydCB8fCBjdXJyZW50UHJlZmVyZW5jZXM/LnNvcnQsXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG5ld1NlYXJjaFF1ZXJ5ID0gcXVlcnlTdHJpbmcuc3RyaW5naWZ5KHNlYXJjaCwgeyBhZGRRdWVyeVByZWZpeDogdHJ1ZSB9KVxuXG4gICAgICBpZiAobmV3U2VhcmNoUXVlcnkubGVuZ3RoID4gMSkge1xuICAgICAgICBoaXN0b3J5LnJlcGxhY2Uoe1xuICAgICAgICAgIHNlYXJjaDogbmV3U2VhcmNoUXVlcnksXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSkoKVxuICB9LCBbY29sbGVjdGlvbiwgZ2V0UHJlZmVyZW5jZSwgcHJlZmVyZW5jZUtleSwgaGlzdG9yeSwgdCwgZGVmYXVsdExpbWl0XSlcblxuICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIFNldCBwcmVmZXJlbmNlcyBvbiBjaGFuZ2VcbiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgdm9pZCBzZXRQcmVmZXJlbmNlKHByZWZlcmVuY2VLZXksIHsgc29ydCB9LCB0cnVlKVxuICB9LCBbc29ydCwgcHJlZmVyZW5jZUtleSwgc2V0UHJlZmVyZW5jZV0pXG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICB2b2lkIHNldFByZWZlcmVuY2UocHJlZmVyZW5jZUtleSwgeyBsaW1pdCB9LCB0cnVlKVxuICB9LCBbbGltaXQsIHByZWZlcmVuY2VLZXksIHNldFByZWZlcmVuY2VdKVxuXG4gIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gUHJldmVudCBnb2luZyBiZXlvbmQgcGFnZSBsaW1pdFxuICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoZGF0YT8udG90YWxEb2NzICYmIGRhdGEucGFnaW5nQ291bnRlciA+IGRhdGEudG90YWxEb2NzKSB7XG4gICAgICBjb25zdCBwYXJhbXMgPSBxdWVyeVN0cmluZy5wYXJzZShoaXN0b3J5LmxvY2F0aW9uLnNlYXJjaCwge1xuICAgICAgICBkZXB0aDogMCxcbiAgICAgICAgaWdub3JlUXVlcnlQcmVmaXg6IHRydWUsXG4gICAgICB9KVxuICAgICAgY29uc3QgbmV3U2VhcmNoUXVlcnkgPSBxdWVyeVN0cmluZy5zdHJpbmdpZnkoXG4gICAgICAgIHtcbiAgICAgICAgICAuLi5wYXJhbXMsXG4gICAgICAgICAgcGFnZTogZGF0YS50b3RhbFBhZ2VzLFxuICAgICAgICB9LFxuICAgICAgICB7IGFkZFF1ZXJ5UHJlZml4OiB0cnVlIH0sXG4gICAgICApXG4gICAgICBoaXN0b3J5LnJlcGxhY2Uoe1xuICAgICAgICBzZWFyY2g6IG5ld1NlYXJjaFF1ZXJ5LFxuICAgICAgfSlcbiAgICB9XG4gIH0sIFtkYXRhLCBoaXN0b3J5LCByZXNldFBhcmFtc10pXG5cbiAgcmV0dXJuIChcbiAgICA8VGFibGVDb2x1bW5zUHJvdmlkZXIgY29sbGVjdGlvbj17Y29sbGVjdGlvbn0+XG4gICAgICA8UmVuZGVyQ3VzdG9tQ29tcG9uZW50XG4gICAgICAgIEN1c3RvbUNvbXBvbmVudD17Q3VzdG9tTGlzdH1cbiAgICAgICAgRGVmYXVsdENvbXBvbmVudD17RGVmYXVsdExpc3R9XG4gICAgICAgIGNvbXBvbmVudFByb3BzPXt7XG4gICAgICAgICAgY29sbGVjdGlvbjogeyAuLi5jb2xsZWN0aW9uLCBmaWVsZHMgfSxcbiAgICAgICAgICBkYXRhLFxuICAgICAgICAgIGhhc0NyZWF0ZVBlcm1pc3Npb24sXG4gICAgICAgICAgbGltaXQ6IGxpbWl0IHx8IGRlZmF1bHRMaW1pdCxcbiAgICAgICAgICBuZXdEb2N1bWVudFVSTCxcbiAgICAgICAgICByZXNldFBhcmFtcyxcbiAgICAgICAgICB0aXRsZUZpZWxkLFxuICAgICAgICB9fVxuICAgICAgLz5cbiAgICA8L1RhYmxlQ29sdW1uc1Byb3ZpZGVyPlxuICApXG59XG5cbmV4cG9ydCBkZWZhdWx0IExpc3RWaWV3XG4iXSwibmFtZXMiOlsiaG9pc3RRdWVyeVBhcmFtc1RvQW5kIiwid2hlcmUiLCJxdWVyeVBhcmFtcyIsImFuZCIsInB1c2giLCJMaXN0VmlldyIsInByb3BzIiwiY29sbGVjdGlvbiIsImFkbWluIiwiY29tcG9uZW50cyIsInZpZXdzIiwiTGlzdCIsIkN1c3RvbUxpc3QiLCJsaXN0U2VhcmNoYWJsZUZpZWxkcyIsInBhZ2luYXRpb24iLCJkZWZhdWx0TGltaXQiLCJsYWJlbHMiLCJwbHVyYWwiLCJzbHVnIiwicm91dGVzIiwiYXBpIiwic2VydmVyVVJMIiwidXNlQ29uZmlnIiwicHJlZmVyZW5jZUtleSIsInBlcm1pc3Npb25zIiwidXNlQXV0aCIsInNldFN0ZXBOYXYiLCJ1c2VTdGVwTmF2IiwiZ2V0UHJlZmVyZW5jZSIsInNldFByZWZlcmVuY2UiLCJ1c2VQcmVmZXJlbmNlcyIsImxpbWl0IiwicGFnZSIsInNlYXJjaCIsInNvcnQiLCJ1c2VTZWFyY2hQYXJhbXMiLCJoaXN0b3J5IiwidXNlSGlzdG9yeSIsInQiLCJ1c2VUcmFuc2xhdGlvbiIsImZldGNoVVJMIiwic2V0RmV0Y2hVUkwiLCJ1c2VTdGF0ZSIsImZpZWxkcyIsImZvcm1hdEZpZWxkcyIsImNvbGxlY3Rpb25QZXJtaXNzaW9ucyIsImNvbGxlY3Rpb25zIiwiaGFzQ3JlYXRlUGVybWlzc2lvbiIsImNyZWF0ZSIsInBlcm1pc3Npb24iLCJuZXdEb2N1bWVudFVSTCIsImRhdGEiLCJzZXRQYXJhbXMiLCJ1c2VQYXlsb2FkQVBJIiwiaW5pdGlhbFBhcmFtcyIsInRpdGxlRmllbGQiLCJ1c2VVc2VUaXRsZUZpZWxkIiwidXNlRWZmZWN0IiwibGFiZWwiLCJyZXNldFBhcmFtcyIsInVzZUNhbGxiYWNrIiwib3ZlcnJpZGVzIiwicGFyYW1zIiwiZGVwdGgiLCJkcmFmdCIsImludm9rZSIsInV1aWQiLCJjb3B5T2ZXaGVyZSIsInNlYXJjaEFzQ29uZGl0aW9ucyIsIm5hbWUiLCJtYXAiLCJmaWVsZE5hbWUiLCJsaWtlIiwibGVuZ3RoIiwiY29uZGl0aW9uYWxTZWFyY2hGaWVsZHMiLCJvciIsImN1cnJlbnRQcmVmZXJlbmNlcyIsInF1ZXJ5U3RyaW5nIiwicGFyc2UiLCJsb2NhdGlvbiIsImlnbm9yZVF1ZXJ5UHJlZml4IiwibmV3U2VhcmNoUXVlcnkiLCJzdHJpbmdpZnkiLCJhZGRRdWVyeVByZWZpeCIsInJlcGxhY2UiLCJ0b3RhbERvY3MiLCJwYWdpbmdDb3VudGVyIiwidG90YWxQYWdlcyIsIlRhYmxlQ29sdW1uc1Byb3ZpZGVyIiwiUmVuZGVyQ3VzdG9tQ29tcG9uZW50IiwiQ3VzdG9tQ29tcG9uZW50IiwiRGVmYXVsdENvbXBvbmVudCIsIkRlZmF1bHRMaXN0IiwiY29tcG9uZW50UHJvcHMiXSwibWFwcGluZ3MiOiI7Ozs7K0JBK05BOzs7ZUFBQTs7OzJEQS9Od0I7K0RBQ2dDOzhCQUN6QjtnQ0FDSjtzQkFDQTtzRUFNRDsrQkFDTzt5QkFDTjs4QkFDVTtzQkFDYjt3QkFDRTs2QkFDSzs4RUFDRzs4QkFDRjtnRUFDUjtxRUFDQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRXpCLE1BQU1BLHdCQUF3QixDQUFDQyxPQUFjQztJQUMzQyxJQUFJLFNBQVNELE9BQU87UUFDbEJBLE1BQU1FLEdBQUcsQ0FBQ0MsSUFBSSxDQUFDRjtJQUNqQixPQUFPLElBQUksUUFBUUQsT0FBTztRQUN4QkEsUUFBUTtZQUNORSxLQUFLO2dCQUFDRjtnQkFBT0M7YUFBWTtRQUMzQjtJQUNGLE9BQU87UUFDTEQsUUFBUTtZQUNORSxLQUFLO2dCQUFDRjtnQkFBT0M7YUFBWTtRQUMzQjtJQUNGO0lBRUEsT0FBT0Q7QUFDVDtBQUVBOzs7OztDQUtDLEdBQ0QsTUFBTUksV0FBcUMsQ0FBQ0M7SUFDMUMsTUFBTSxFQUNKQyxVQUFVLEVBQ1ZBLFlBQVksRUFDVkMsT0FBTyxFQUNMQyxZQUFZLEVBQUVDLE9BQU8sRUFBRUMsTUFBTUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsRUFDckRDLG9CQUFvQixFQUNwQkMsWUFBWSxFQUFFQyxZQUFZLEVBQUUsRUFDN0IsRUFDREMsUUFBUSxFQUFFQyxNQUFNLEVBQUUsRUFDbEJDLElBQUksRUFDTCxFQUNGLEdBQUdaO0lBRUosTUFBTSxF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